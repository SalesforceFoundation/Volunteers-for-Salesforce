minimum_cumulusci_version: 2.5.0
project:
    name: Volunteers-for-Salesforce
    package:
        name: Volunteers for Salesforce
        namespace: GW_Volunteers
        api_version: '40.0'
        install_class: InstallScript
    git:
        prefix_release: rel/

tasks:
    deploy_dev_config:
        description: Deploys the post install configuration for an unmanaged DE org
        class_path: cumulusci.tasks.salesforce.Deploy
        options:
            path: unpackaged/config/dev

    deploy_qa_config:
        description: Deploys the post install configuration for a regression or QA scratch org
        class_path: cumulusci.tasks.salesforce.Deploy
        options:
            path: unpackaged/config/qa

    deploy_delete_config:
        description: Deploys the metadata deletions for the post install DE org config
        class_path: cumulusci.tasks.salesforce.Deploy
        options:
            path: unpackaged/config/delete

    deploy_package_settings:
        description: Configure the default Volunteers Package Settings
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            path: scripts/DeployScript.cls
            apex: insertPackageSettings();

    assign_pset:
        description: Runs anonymous apex to assign pset for guest user.
        class_path: cumulusci.tasks.apex.anon.AnonymousApexTask
        options:
            apex: >
                Id psetId = [SELECT ID From PermissionSet WHERE Name = 'V4S_Site_Minimum' LIMIT 1][0].id;
                Id guestId = [SELECT ID From User WHERE Name = 'Volunteers Site Guest User' LIMIT 1][0].id;
                insert new PermissionSetAssignment(PermissionSetId=psetId, AssigneeId=guestId);
    
    deploy_test_data:
        description: 'Loads a test data set for Volunteers for Salesforce'
        class_path: cumulusci.tasks.bulkdata.LoadData
        options:
            sql_path: 'datasets/regression/test_data.sql'
            mapping: 'datasets/regression/mapping.yml'

    delete_test_data:
        description: 'WARNING: deletes all data in sObjects used for testing'
        class_path: cumulusci.tasks.bulkdata.DeleteData
        options:
            objects:
                - Volunteer_Hours__c
                - Volunteer_Shift__c
                - Job_Recurrence_Schedule__c
                - Volunteer_Recurrence_Schedule__c
                - Volunteer_Job__c
                - Contact
                - Account
                - Campaign

    deploy_test_data_managed:
        description: 'Loads a test data set for Volunteers for Salesforce to a managed install'
        class_path: cumulusci.tasks.bulkdata.LoadData
        options:
            sql_path: 'datasets/regression/test_data.sql'
            mapping: 'datasets/regression/mapping_managed.yml'
    
    delete_test_data_managed:
        description: 'WARNING: deletes all data in sObjects used for testing'
        class_path: cumulusci.tasks.bulkdata.DeleteData
        options:
            objects:
                - GW_Volunteers__Volunteer_Hours__c
                - GW_Volunteers__Volunteer_Shift__c
                - GW_Volunteers__Job_Recurrence_Schedule__c
                - GW_Volunteers__Volunteer_Recurrence_Schedule__c
                - GW_Volunteers__Volunteer_Job__c
                - Contact
                - Account
                - Campaign

    capture_test_data:
        description: 'Capture test data from an org'
        class_path: cumulusci.tasks.bulkdata.ExtractData
        options:
            sql_path: 'datasets/regression/test_data.sql'
            mapping: 'datasets/regression/mapping.yml'
flows:
    ci_feature:
        description: Deploys the unmanaged package metadata and all dependencies to the target org and runs tests
        tasks:
            5:
                task: None

    config_dev:
        steps:
            3:
                task: deploy_delete_config
            4:
                task: deploy_dev_config
                options:
                    unmanaged: True
                    namespace_inject: $project_config.project__package__namespace
            5:
                task: deploy_package_settings
            6:
                task: assign_pset
                ignore_failure: True
            7:
                task: deploy_test_data

    config_qa:
        steps:
            3:
                task: deploy_delete_config
            4:
                task: deploy_dev_config
                options:
                    unmanaged: True
                    namespace_inject: $project_config.project__package__namespace
            5:
                task: deploy_qa_config
                options:
                    unmanaged: True
                    namespace_inject: $project_config.project__package__namespace
            6:
                task: deploy_package_settings
            7:
                task: assign_pset
                ignore_failure: True
            8:
                task: deploy_test_data

    config_regression:
        steps:
            2:
                task: deploy_delete_config
            3:
                task: deploy_dev_config
                options:
                    unmanaged: False
                    namespace_inject: $project_config.project__package__namespace
            4:
                task: deploy_qa_config
                options:
                    unmanaged: False
                    namespace_inject: $project_config.project__package__namespace
            5:
                task: assign_pset
            6:
                task: deploy_test_data_managed

orgs:
    scratch:
        dev_namespaced:
            config_file: orgs/dev.json
            namespaced: True
            days: 7
        prerelease:
            config_file: orgs/prerelease.json

